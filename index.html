<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nakama Sync - Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg-top:#0f2027; --bg-bot:#203a43; --card-bg:#151b24; --text-main:#ecf0f1; --text-muted:#95a5a6; --gold:#f1c40f; --red:#ff4757; --blue:#3742fa; --border:#2c3e50; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: var(--text-main); overflow-x: hidden; background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 100%); background-attachment: fixed; }
        
        /* INTRO */
        #intro-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a2a6c 0%, #0f0f0f 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; opacity: 1; transition: opacity 0.8s ease-in-out, visibility 0.8s; }
        .intro-content-box { position: relative; display: flex; justify-content: center; align-items: center; }
        .intro-logo-img { width: 200px; height: auto; opacity: 0; transform: translateY(30px) scale(0.9); animation: floatInEpic 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.5)); position: relative; z-index: 2; }
        .intro-glow { position: absolute; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,215,0,0.25) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; opacity: 0; animation: pulseGlow 2s ease-in-out forwards 0.5s; }
        @keyframes floatInEpic { to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulseGlow { 0% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.8; transform: scale(1); } }
        .intro-fade-out { opacity: 0 !important; visibility: hidden; transform: scale(1.1); filter: blur(10px); }

        /* RULETA */
        #roulette-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .roulette-title { color: var(--gold); font-size: 2rem; margin-bottom: 30px; text-transform: uppercase; animation: blink 1s infinite; text-align: center; }
        .roulette-wheel { width: 300px; height: 300px; border-radius: 50%; border: 10px solid var(--gold); position: relative; overflow: hidden; transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); box-shadow: 0 0 50px rgba(241, 196, 15, 0.5); background: conic-gradient(from 0deg, #e74c3c 0%, #3498db 50%, #e74c3c 100%); display: flex; align-items: center; justify-content: center; }
        .roulette-arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid white; z-index: 5001; filter: drop-shadow(0 5px 5px black); }
        .roulette-names { position: absolute; width: 100%; height: 100%; text-align: center; font-weight: bold; font-size: 1.2rem; color: white; display: flex; justify-content: center; align-items: center; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* HEADER & CONTAINER */
        .header-container { text-align: center; margin-top: 10px; margin-bottom: 20px; animation: float 6s ease-in-out infinite; }
        .header-logo { max-width: 280px; width: 80%; height: auto; display: block; margin: 0 auto 5px; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2)); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .container { width: 100%; max-width: 400px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 10; animation: fadeIn 0.5s; }
        
        @media (min-width: 768px) { #setupScreen.container { max-width: 800px; flex-direction: row; align-items: flex-start; } .setup-left { flex: 1; min-width: 300px; } .setup-right { flex: 1; border-left: 1px solid var(--border); padding-left: 20px; min-height: 250px; } }
        @media (max-width: 767px) { .setup-right { border-top: 1px solid var(--border); padding-top: 20px; margin-top: 10px; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #gameScreen, #votingScreen, #lobbyScreen { display: none; }

        input, select { width: 100%; padding: 16px; border-radius: 12px; border: 2px solid var(--border); background: #0b1015; color: white; font-size: 1.1rem; text-align: center; font-family: inherit; font-weight: 700; outline: none; }
        input:focus, select:focus { border-color: var(--red); } 
        input { text-transform: uppercase; } label { font-size: 0.8rem; color: var(--gold); font-weight: 800; margin-bottom: 8px; display: block; }
        
        .user-saved-box { display: none; align-items: center; justify-content: space-between; background: #1e272e; padding: 15px; border-radius: 12px; border: 1px solid var(--blue); }
        .user-saved-name { font-size: 1.2rem; font-weight: 900; color: white; }
        .btn-settings { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0 10px; color: var(--text-muted); transition: 0.2s; box-shadow: none; width: auto; }
        .btn-settings:hover { color: var(--gold); transform: rotate(45deg); }

        button { width: 100%; padding: 18px; border-radius: 12px; border: none; font-family: inherit; font-weight: 900; font-size: 1rem; text-transform: uppercase; cursor: pointer; transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.4); }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.4); } button.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .btn-main { background: var(--red); color: white; } .btn-blue { background: var(--blue); color: white; margin-top: 10px; } .btn-vote { background: var(--gold); color: #2c3e50; margin-top: auto; } .btn-photo { background: #0b1015; color: var(--gold); border: 1px solid var(--gold); padding: 10px 20px; border-radius: 50px; font-size: 0.8rem; margin-top: 15px; display: inline-flex; align-items: center; gap: 8px; } .btn-clean { background: transparent; border: 1px solid #c0392b; color: #c0392b; margin-top:10px; padding: 10px; font-size: 0.8rem; } .btn-kick { background: none; border: none; color: #e74c3c; font-size: 1.2rem; cursor: pointer; padding: 0 5px; margin-left: 10px; box-shadow: none; width: auto; } .btn-kick:hover { transform: scale(1.2); }
        
        .player-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; background: #0b1015; border-radius: 10px; border: 1px solid var(--border); }
        .player-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .online-dot { height: 10px; width: 10px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 5px #2ecc71; }

        .room-list-box { margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .room-item { background: #0b1015; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { border-color: var(--blue); background: #151b24; }
        .room-code { color: var(--gold); font-weight: bold; font-size: 1.1rem; }
        .room-count { color: var(--text-muted); font-size: 0.8rem; }
        .room-time { color: var(--red); font-size: 0.7rem; font-weight: bold; margin-top: 2px; }
        .room-join-txt { color: var(--blue); font-weight: bold; font-size: 0.8rem; }

        .card-wrapper { width: 100%; height: 350px; margin-bottom: 20px; }
        .big-card { width: 100%; height: 100%; background: #1e272e; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .big-card.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .card-icon { font-size: 4rem; margin-bottom: 15px; } .card-name { font-size: 2rem; font-weight: 900; color: white; margin: 0; text-transform: uppercase; } .card-hint { color: var(--red); font-size: 0.8rem; font-weight: 800; margin-top: 15px; }
        
        .voting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .vote-card { background: #252f38; border-radius: 10px; padding: 20px 5px; text-align: center; font-weight: 700; cursor: pointer; color: white; border: 2px solid transparent; position: relative; }
        .vote-card.selected { border-color: var(--gold); background: #2f3640; }
        .vote-badge { position: absolute; top: -8px; right: -8px; background: var(--red); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; border: 2px solid #1e272e; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 5; opacity: 0; transform: scale(0); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .vote-badge.visible { opacity: 1; transform: scale(1); }

        .reveal-box { background: #1e272e; border-radius: 15px; padding: 20px; text-align: center; border: 1px dashed var(--border); margin-top: 20px; }
        .secret-name { color: var(--gold); font-size: 2rem; font-weight: 900; display: none; margin: 10px 0; }
        .btn-reveal { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 8px 20px; border-radius: 50px; font-size: 0.8rem; cursor: pointer; margin-top: 10px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #1e272e; width: 100%; max-width: 350px; padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--border); }
        .role-emoji { font-size: 5rem; display: block; margin-bottom: 10px; } .role-title { font-size: 2.2rem; font-weight: 900; margin: 0; text-transform: uppercase; } .role-desc { margin: 15px 0 20px; color: #bdc3c7; line-height: 1.4; }
        .impostor { color: var(--red); } .crew { color: var(--blue); } .win { color: #2ecc71; } .draw { color: var(--gold); }
        .btn-close { background: #0b1015; color: white; padding: 12px 30px; border-radius: 50px; border: 1px solid #555; font-weight: bold; cursor: pointer; margin-top: 15px;}

        .wanted-paper { background: #f1eacc; padding: 15px; border: 4px solid #5a4033; transform: rotate(-2deg); position: relative; width: 300px; } .wanted-title { font-family: 'Times New Roman', serif; font-weight: 900; font-size: 3rem; color: #3e2723; margin: 0; letter-spacing: 5px; line-height: 1; text-align: center; } .wanted-sub { font-family: 'Times New Roman', serif; font-size: 0.9rem; color: #3e2723; margin-bottom: 10px; font-weight: bold; text-align: left; margin-left: 15px; } .wanted-img-box { width: 100%; height: 220px; background: #888; border: 3px solid #3e2723; display: flex; align-items: center; justify-content: center; overflow: hidden; } #charImage { width: 100%; height: 100%; object-fit: cover; display: none; } .wanted-name { font-family: 'Times New Roman', serif; font-size: 1.8rem; font-weight: 900; color: #3e2723; text-transform: uppercase; margin-top: 15px; text-align: center; } .wanted-value { position: absolute; bottom: 15px; left: 0; width: 100%; text-align: center; font-family: 'Times New Roman'; font-weight: bold; font-size: 1.2rem; color: #3e2723; } .close-x { position: absolute; top: -15px; right: -15px; background: var(--red); color: white; width: 35px; height: 35px; border-radius: 50%; line-height: 35px; text-align: center; font-weight: bold; border: 2px solid white; cursor: pointer; } .loader { border: 4px solid #ccc; border-top: 4px solid var(--red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .timer-box { font-size: 1.5rem; font-weight: bold; color: var(--gold); border: 1px solid var(--gold); border-radius: 10px; padding: 5px 15px; margin-bottom: 10px; display: inline-block; background: #000; }
        .event-box { margin-bottom: 15px; background: rgba(55, 66, 250, 0.2); border: 1px solid var(--blue); padding: 10px; border-radius: 10px; color: #fff; font-size: 0.9rem; display: none; animation: fadeIn 0.5s; }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--red); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000; top: 30px; font-weight: bold; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }
    </style>
</head>
<body>

    <div id="intro-loader">
        <div class="intro-content-box">
            <div class="intro-glow"></div>
            <img src="jolly.png" class="intro-logo-img" alt="Cargando..." onerror="this.style.display='none'; document.getElementById('intro-loader').style.display='none';">
        </div>
    </div>

    <div id="roulette-screen">
        <div class="roulette-title">¬°EMPATE! üé≤</div>
        <div style="position:relative;">
            <div class="roulette-arrow"></div>
            <div class="roulette-wheel" id="rouletteWheel"></div>
        </div>
        <p style="color:#aaa; margin-top:20px;">La suerte decide qui√©n cae al mar...</p>
    </div>

    <div class="ocean"><div class="wave"></div><div class="wave"></div></div>
    <div id="toast">Mensaje</div>

    <div class="header-container" id="mainHeader">
        <img src="logo.png" alt="Logo One Piece" class="header-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h1 style="display:none;">NAKAMA SYNC</h1>
    </div>

    <div id="setupScreen" class="container">
        <div class="setup-left">
            <h2 style="color:var(--gold); margin-top:0;">UNIRSE / CREAR</h2>
            <div class="input-group">
                <label>1. CLAVE DE LA SALA</label>
                <input type="text" id="seedInput" placeholder="EJ: WANO" autocomplete="off">
            </div>
            <div class="input-group" style="margin-top:15px;">
                <label>2. TU NOMBRE (OBLIGATORIO)</label>
                <input type="text" id="myPlayerName" placeholder="TU NOMBRE PIRATA" autocomplete="off">
                <div id="savedNameBox" class="user-saved-box">
                    <span id="displaySavedName" class="user-saved-name"></span>
                    <button class="btn-settings" onclick="cambiarNombre()" title="Cambiar Nombre">‚öôÔ∏è</button>
                </div>
            </div>
            <button class="btn-main" style="margin-top:20px;" onclick="unirseSala()">UNIRSE A LA SALA üè¥‚Äç‚ò†Ô∏è</button>
        </div>
        <div class="setup-right">
            <h3 style="color:var(--text-muted); margin:0 0 10px 0; font-size:0.9rem;">SALAS ACTIVAS</h3>
            <div id="activeRooms" class="room-list-box"><div style="color:#555; font-size:0.8rem; text-align:center;">Buscando salas...</div></div>
        </div>
    </div>

    <div id="lobbyScreen" class="container">
        <h2 style="color:var(--gold); margin:0; text-align:center;">SALA: <span id="lobbyRoomName"></span></h2>
        <div style="text-align:center; color:#aaa; font-size:0.8rem; margin-bottom:15px;">Esperando a la tripulaci√≥n...</div>
        <ul id="onlinePlayerList" class="player-list"></ul>
        <div style="text-align:center; margin-top:10px; color:var(--text-muted);"><span id="onlineCount">0</span> Nakamas conectados</div>
        
        <div id="adminSection" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:10px;">
            <label style="color:var(--blue);">MODO DE JUEGO:</label>
            <select id="gameModeSelect" style="margin-bottom:10px;">
                <option value="CLASSIC">‚öì CL√ÅSICO</option>
                <option value="AKUMA">üçá AKUMA NO MI (EVENTOS)</option>
                <option value="REVERSE">üë∫ TODOS CONTRA UNO</option>
            </select>

            <label>PALABRA SECRETA (OPCIONAL)</label>
            <input type="text" id="customWordInput" placeholder="EJ: MINECRAFT" style="border-color:var(--blue);">
        </div>

        <div id="impostorInfo" style="text-align:center; color:var(--red); font-weight:bold; margin-top:15px; font-size:0.9rem;">‚ö†Ô∏è HABR√Å 1 IMPOSTOR</div>

        <button id="btnZarpar" class="btn-main disabled" style="margin-top:20px;" onclick="comenzarPartida()">ESPERANDO AL CAPIT√ÅN... ‚è≥</button>
        <button id="btnClean" class="btn-clean" style="display:none;" onclick="limpiarSala()">üóëÔ∏è ELIMINAR SALA (BORRAR TODO)</button>
        <button class="btn-blue" onclick="copiarLink()">üîó COPIAR ENLACE</button>
    </div>

    <div id="gameScreen" class="container">
        <div class="room-tag" id="roomInfo">SALA: ???</div>
        <div id="gameTimer" class="timer-box">03:00</div>
        <div id="eventDisplay" class="event-box"></div>
        <div class="card-wrapper">
            <div class="big-card" id="myCard" onclick="revelarMiRol()">
                <div class="card-icon">üëÜ</div>
                <h2 class="card-name" id="cardNameDisplay">NOMBRE</h2>
                <div class="card-hint">TOCA PARA VER TU ROL</div>
            </div>
        </div>
        <button class="btn-vote" onclick="irAVotacion()">üó≥Ô∏è IR A VOTACI√ìN</button>
    </div>

    <div id="votingScreen" class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="color:var(--red); margin:0;">VOTACI√ìN</h2>
            <p id="votingStatus" style="color:#aaa; font-size:0.8rem;">Elige a qui√©n expulsar por la borda</p>
        </div>
        <div class="voting-grid" id="votingGrid"></div>
        <div class="reveal-box">
            <h2 id="secretCharacterDisplay" class="secret-name">???</h2>
            <button id="btnImgSecret" class="btn-photo" style="display:none;" onclick="abrirFotoModal(personajePartida)">üì∑ VER FOTO</button>
            <button class="btn-reveal" id="btnShowChar" onclick="mostrarPersonajeSecreto()">üëÅÔ∏è REVELAR SOLUCI√ìN</button>
        </div>
        <button class="btn-blue" onclick="location.reload()" style="margin-top:10px;">üè† SALIR</button>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content">
            <span id="modalIcon" class="role-emoji"></span>
            <h2 id="modalTitle" class="role-title"></h2>
            <div id="modalDesc" class="role-desc"></div>
            <div id="modalImageContainer"></div>
            <div id="modalButtons" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <div id="imgModal" class="modal-overlay" style="z-index: 3000;">
        <div class="wanted-paper">
            <span class="close-x" onclick="cerrarFotoModal()">‚úï</span>
            <h3 class="wanted-title">WANTED</h3>
            <div class="wanted-sub">DEAD OR ALIVE</div>
            <div class="wanted-img-box"><div class="loader" id="imgLoader"></div><img id="charImage" src="" alt=""></div>
            <h2 class="wanted-name" id="wantedName"></h2>
            <div class="wanted-value">‡∏ø 500,000,000-</div>
        </div>
    </div>

    <script>
        const personajes = ["Luffy", "Zoro", "Nami", "Usopp", "Sanji", "Chopper", "Robin", "Franky", "Brook", "Jinbe", "Zeus", "Shanks", "Teach", "Buggy", "Shirohige", "Kaido", "Big Mom", "Luffy Gear 5", "Roger", "Rayleigh", "Oden", "Xebec", "Shiki", "Fisher Tiger", "Noland", "Calgara", "Akainu", "Kizaru", "Aokiji", "Fujitora", "Ryokugyu", "Sengoku", "Garp", "Tsuru", "Kong", "Smoker", "Tashigi", "Koby", "Helmeppo", "Hina", "Sentomaru", "X Drake", "Prince Grus", "Hibari", "Mihawk", "Crocodile", "Doflamingo", "Kuma", "Hancock", "Moria", "Law", "Weevil", "Kid", "Killer", "Bege", "Bonney", "Hawkins", "Apoo", "Urouge", "Imu", "Saturn", "Ju Peter", "Warcury", "Nusjuro", "Mars", "Garling", "Lucci", "Kaku", "Stussy", "Spandam", "Magellan", "Hannyabal", "Shiryu", "Sadi", "Yamato", "Momonosuke", "Kinemon", "Raizo", "Denjiro", "Kiku", "Kawamatsu", "Ashura", "Inuarashi", "Nekomamushi", "Hiyori", "Orochi", "Kanjuro", "Marco", "Ace", "Jozu", "Vista", "Izo", "Katakuri", "Perospero", "Cracker", "Smoothie", "Pudding", "King", "Queen", "Jack", "Ulti", "Page One", "Black Maria", "Who's Who", "Sasaki", "Benn Beckman", "Yasopp", "Lucky Roux", "Burgess", "Van Augur", "Doc Q", "Laffitte", "Catarina Devon", "Vasco Shot", "Avalo Pizarro", "Sanjuan Wolf", "Arlong", "Krieg", "Kuro", "Wapol", "Enel", "Foxy", "Hody Jones", "Caesar", "Monet", "Vergo", "Diamante", "Pica", "Trebol", "Sugar", "Senor Pink", "Bartolomeo", "Cavendish", "Dragon", "Sabo", "Koala", "Ivankov", "Inazuma", "Karasu", "Belo Betty", "Morley", "Lindbergh", "Ginny", "Vegapunk", "Shaka", "Lilith", "Edison", "Pythagoras", "Atlas", "York", "Vivi", "Karoo", "Carrot", "Pedro", "Wanda", "Zunesha", "Laboon", "Shirahoshi", "Neptune", "Kyros", "Rebecca", "Bellamy", "Bon Clay", "Kureha", "Hiriluk", "Zeff", "Dadan", "Makino", "Morgans", "Perona", "Hatchan", "Camie", "Duval", "Shakky", "Wyper", "Iceburg", "Paulie", "Kokoro", "Chimney"];
        
        let miNombre = "", seedActual = "", gameSeed = "", jugadores = [], pollingInterval = null;
        let miRol = "", personajePartida = "", soyLider = false, partidaIniciadaLocal = false;
        let heVotado = false, timerInterval = null, roulettePlayed = false;

        window.onload = () => { 
            setTimeout(() => {
                const loader = document.getElementById('intro-loader');
                loader.classList.add('intro-fade-out');
                setTimeout(() => { loader.style.display = 'none'; }, 800);
            }, 3000);
            cargarSalas(); setInterval(cargarSalas, 5000); cargarNombreGuardado(); 
        };

        function cargarNombreGuardado() {
            const saved = localStorage.getItem('nakama_name');
            if(saved) {
                miNombre = saved; document.getElementById('myPlayerName').value = saved;
                document.getElementById('myPlayerName').style.display = 'none';
                document.getElementById('savedNameBox').style.display = 'flex';
                document.getElementById('displaySavedName').innerText = `HOLA, ${saved}`;
            } else {
                document.getElementById('myPlayerName').style.display = 'block'; document.getElementById('savedNameBox').style.display = 'none';
            }
        }
        function cambiarNombre() { localStorage.removeItem('nakama_name'); miNombre = ""; document.getElementById('myPlayerName').value = ""; document.getElementById('myPlayerName').style.display = 'block'; document.getElementById('savedNameBox').style.display = 'none'; document.getElementById('myPlayerName').focus(); }

        async function cargarSalas() {
            if(document.getElementById('setupScreen').style.display === 'none') return;
            try {
                const res = await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'list' }) });
                if(res.ok) {
                    const rooms = await res.json();
                    const container = document.getElementById('activeRooms');
                    if(rooms.length === 0) { container.innerHTML = '<div style="color:#555; font-size:0.8rem; text-align:center;">No hay salas activas.<br>¬°Crea una!</div>'; return; }
                    container.innerHTML = '';
                    rooms.forEach(r => {
                        const minsLeft = Math.max(0, Math.floor(30 - (new Date() - new Date(r.created_at)) / 1000 / 60));
                        const div = document.createElement('div'); div.className = 'room-item';
                        div.innerHTML = `<div><div class="room-code">${r.room_code}</div><div class="room-count">üë• ${r.count} Piratas</div><div class="room-time">‚è≥ Expira en: ${minsLeft} min</div></div><div class="room-join-txt">ENTRAR ‚û°Ô∏è</div>`;
                        div.onclick = () => unirseDesdeLista(r.room_code);
                        container.appendChild(div);
                    });
                }
            } catch(e) {}
        }

        function unirseDesdeLista(roomCode) {
            let name = document.getElementById('myPlayerName').value.trim().toUpperCase();
            const saved = localStorage.getItem('nakama_name'); if(saved) name = saved;
            if(!name) { showToast("‚ö†Ô∏è ¬°PRIMERO PON TU NOMBRE!"); document.getElementById('myPlayerName').focus(); return; }
            document.getElementById('seedInput').value = roomCode; unirseSala();
        }

        async function unirseSala() {
            seedActual = document.getElementById('seedInput').value.trim().toUpperCase();
            let nameInput = document.getElementById('myPlayerName').value.trim().toUpperCase();
            const saved = localStorage.getItem('nakama_name'); miNombre = saved ? saved : nameInput;
            if(!miNombre || !seedActual) { showToast("¬°Datos incompletos!"); return; }
            
            partidaIniciadaLocal = false; heVotado = false; roulettePlayed = false;
            try {
                const res = await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'join', room: seedActual, player: miNombre }) });
                if(res.ok) { localStorage.setItem('nakama_name', miNombre); irALobby(); }
                else if(res.status === 409) showToast("‚õî NOMBRE OCUPADO");
                else showToast("Error al conectar");
            } catch(e) { showToast("Error fatal"); }
        }

        function irALobby() {
            document.getElementById('setupScreen').style.display = 'none'; document.getElementById('votingScreen').style.display = 'none'; document.getElementById('gameScreen').style.display = 'none'; document.getElementById('mainHeader').style.display = 'block'; document.getElementById('lobbyScreen').style.display = 'flex';
            document.getElementById('lobbyRoomName').innerText = seedActual;
            if(pollingInterval) clearInterval(pollingInterval);
            actualizarLista(); pollingInterval = setInterval(actualizarLista, 2000); 
        }

        async function actualizarLista() {
            try {
                const res = await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'get', room: seedActual, player: miNombre }) });
                if(res.ok) {
                    const data = await res.json();
                    if(data.restart) { location.reload(); return; }
                    
                    jugadores = data.players; soyLider = (data.leader === miNombre); gameSeed = data.seed;
                    
                    if (data.started && !partidaIniciadaLocal) { partidaIniciadaLocal = true; iniciarJuegoCliente(); }
                    else if (!data.started && partidaIniciadaLocal) { location.reload(); }
                    else if (!partidaIniciadaLocal) { renderizarLista(data.leader); }

                    if (data.ejected) {
                        gestionarResultado(data);
                        if(data.votes) actualizarVotos(data.votes);
                        document.getElementById('btnShowChar').style.display = 'inline-block';
                    }
                    if (data.hasVoted) { heVotado = true; document.getElementById('votingStatus').innerText = "ESPERANDO AL RESTO DE NAKAMAS..."; }
                }
            } catch(e) { console.error(e); }
        }

        function gestionarResultado(data) {
            const votes = data.votes || {};
            let maxV = 0; Object.values(votes).forEach(v => { if(v > maxV) maxV = v; });
            const tied = Object.keys(votes).filter(k => votes[k] === maxV);

            if (tied.length > 1 && !roulettePlayed) {
                roulettePlayed = true; 
                jugarRuleta(tied, data.ejected);
            } else if (tied.length === 1 || roulettePlayed) {
                mostrarResultadoVotacion(data.ejected);
            }
        }

        function jugarRuleta(candidatos, perdedorReal) {
            const screen = document.getElementById('roulette-screen');
            const wheel = document.getElementById('rouletteWheel');
            screen.style.display = 'flex';
            
            let gradientStr = "conic-gradient(";
            const colors = ["#e74c3c", "#3498db", "#f1c40f", "#9b59b6", "#2ecc71"];
            const step = 360 / candidatos.length;
            candidatos.forEach((c, i) => {
                gradientStr += `${colors[i % colors.length]} ${i*step}deg ${(i+1)*step}deg${i === candidatos.length-1 ? '' : ','}`;
            });
            gradientStr += ")";
            wheel.style.background = gradientStr;
            wheel.innerHTML = `<div class="roulette-names" style="transform: rotate(0deg)">${candidatos.join(" vs ")}</div>`;

            setTimeout(() => {
                const rotation = 3600 + Math.random() * 360; 
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                setTimeout(() => {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    setTimeout(() => {
                        screen.style.display = 'none';
                        mostrarResultadoVotacion(perdedorReal);
                    }, 2000);
                }, 4000);
            }, 100);
        }

        function actualizarVotos(votes) {
            const grid = document.getElementById('votingGrid');
            if(grid.children.length === 0) return;
            for(let btn of grid.children) {
                const pName = btn.innerText; const count = votes[pName] || 0;
                let badge = btn.querySelector('.vote-badge'); if(!badge) { badge = document.createElement('div'); badge.className = 'vote-badge'; btn.appendChild(badge); }
                if(count > 0) { badge.innerText = count; badge.classList.add('visible'); } else { badge.classList.remove('visible'); }
            }
        }

        function renderizarLista(leaderName) {
            const list = document.getElementById('onlinePlayerList'); list.innerHTML = '';
            jugadores.forEach(p => {
                const isCaptain = p === leaderName ? "üëë" : "";
                let kickBtn = "";
                if ((soyLider || miNombre === "STRIOLO") && p !== miNombre) kickBtn = `<button class="btn-kick" onclick="kickPlayer('${p}')">‚ùå</button>`;
                list.innerHTML += `<li class="player-item"><span><span class="online-dot"></span> ${p} ${isCaptain}</span>${kickBtn}</li>`;
            });
            document.getElementById('onlineCount').innerText = jugadores.length;
            
            const btnZarpar = document.getElementById('btnZarpar');
            const btnClean = document.getElementById('btnClean');
            const adminSec = document.getElementById('adminSection');
            
            if (soyLider || miNombre === "STRIOLO") btnClean.style.display = 'block'; else btnClean.style.display = 'none';
            if (soyLider) { 
                btnZarpar.innerText = "ZARPAR TODOS ‚öì"; btnZarpar.classList.remove('disabled'); 
                adminSec.style.display = 'block';
            } else { 
                btnZarpar.innerText = "ESPERANDO AL CAPIT√ÅN... ‚è≥"; btnZarpar.classList.add('disabled'); 
                adminSec.style.display = 'none';
            }
        }

        async function comenzarPartida() {
            if(!soyLider) return;
            if(jugadores.length < 3) { showToast("M√≠nimo 3 jugadores"); return; }
            const custom = document.getElementById('customWordInput').value;
            const mode = document.getElementById('gameModeSelect').value;
            try { await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'start', room: seedActual, player: miNombre, customWord: custom, gameMode: mode }) }); } catch(e) {}
        }

        async function reiniciarPartida() { try { await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'reset', room: seedActual, player: miNombre }) }); } catch(e) {} }
        async function limpiarSala() { if(!confirm("‚ö†Ô∏è ¬øBORRAR SALA?")) return; try { await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'clean', room: seedActual, player: miNombre }) }); } catch(e) {} }
        async function kickPlayer(target) { if(!confirm(`¬øEchar a ${target}?`)) return; try { await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'kick', room: seedActual, player: miNombre, target: target }) }); } catch(e) {} }

        function iniciarJuegoCliente() {
            jugadores.sort(); 
            // SEMILLA: RANDOM | PALABRA | MODO | EVENTO
            const seedParts = gameSeed.split('|');
            const baseSeed = seedParts[0] || gameSeed;
            const customWord = (seedParts[1] && seedParts[1] !== 'NONE') ? seedParts[1] : null;
            const gameMode = seedParts[2] || 'CLASSIC';
            const eventType = seedParts[3] || 'NO_EVENT';

            const seed = cyrb128(seedActual + baseSeed);
            const rand = sfc32(seed[0], seed[1], seed[2], seed[3]);
            
            if (customWord) personajePartida = customWord;
            else personajePartida = personajes[Math.floor(rand() * personajes.length)];

            // ASIGNAR ROLES SEG√öN MODO
            const numImpostores = jugadores.length >= 8 ? 2 : 1;
            let roles = [];

            if (gameMode === 'REVERSE') {
                // MODO TODOS VS UNO: Todos son "Impostores" (no saben), Uno es "Detective" (sabe)
                roles = Array(jugadores.length - 1).fill("___IMPOSTOR___");
                roles.push(personajePartida); // El rol "bueno" aqu√≠ es saber la palabra
            } else {
                // MODO CLASICO / AKUMA
                roles = Array(jugadores.length - numImpostores).fill(personajePartida);
                for(let k=0; k<numImpostores; k++) roles.push("___IMPOSTOR___");
            }

            // BARAJAR
            for(let i=roles.length-1; i>0; i--){const j=Math.floor(rand()*(i+1));[roles[i],roles[j]]=[roles[j],roles[i]];}
            rolesPartida = roles;
            const miIndice = jugadores.indexOf(miNombre);
            miRol = (miIndice !== -1) ? roles[miIndice] : "ERROR";

            // EVENTOS (SOLO VISUAL)
            const eventBox = document.getElementById('eventDisplay');
            if (eventType === 'EVENT_ROOM' && gameMode === 'AKUMA') {
                eventBox.innerHTML = "üòà <b>ROOM DE LAW:</b><br>¬°Los roles han sido barajados en secreto!";
                eventBox.style.display = 'block';
            } else {
                eventBox.style.display = 'none';
            }

            document.getElementById('lobbyScreen').style.display = 'none'; document.getElementById('mainHeader').style.display = 'none'; document.getElementById('gameScreen').style.display = 'flex'; document.getElementById('roomInfo').innerText = `SALA: ${seedActual}`; document.getElementById('cardNameDisplay').innerText = miNombre; resetCardVisual();
            iniciarTimer();
        }

        function iniciarTimer() {
            if (timerInterval) clearInterval(timerInterval);
            let timeLeft = 180; 
            const timerEl = document.getElementById('gameTimer');
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
                timerEl.innerText = `${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); timerEl.innerText = "¬°A VOTAR!"; timerEl.style.color = "var(--red)"; navigator.vibrate([200, 100, 200]); }
            }, 1000);
        }

        function revelarMiRol() {
            const card = document.getElementById('myCard');
            if(card.classList.contains('disabled')) return;
            const icon=document.getElementById('modalIcon'), title=document.getElementById('modalTitle'), desc=document.getElementById('modalDesc');
            const imgContainer = document.getElementById('modalImageContainer'); imgContainer.innerHTML = '';
            document.getElementById('modalButtons').innerHTML = '<button class="btn-close" onclick="closeModal()">ENTENDIDO</button>';

            // L√≥gica visual para REVERSE (Todos contra Uno)
            // Si miRol es la palabra secreta -> Soy el √öNICO que sabe (Detective)
            // Si miRol es ___IMPOSTOR___ -> No s√© nada (La turba)
            const seedParts = gameSeed.split('|');
            const gameMode = seedParts[2] || 'CLASSIC';

            if (gameMode === 'REVERSE') {
                if (miRol === "___IMPOSTOR___") {
                    icon.innerText="ü§∑‚Äç‚ôÇÔ∏è"; title.innerText="DESPISTADO"; title.className="role-title impostor";
                    desc.innerHTML="No sabes la palabra.<br>Finge que sabes y encuentra al que realmente sabe.";
                } else {
                    icon.innerText="üïµÔ∏è‚Äç‚ôÇÔ∏è"; title.innerText="SABIO SOLITARIO"; title.className="role-title crew";
                    desc.innerHTML=`Eres el √∫nico que lo sabe.<br>La palabra es: <span style="color:var(--gold); font-size:1.5rem; display:block; margin-top:5px;">${personajePartida}</span>`;
                    imgContainer.innerHTML = `<button class="btn-photo" onclick="abrirFotoModal('${personajePartida}')">üì∑ VER FOTO</button>`;
                }
            } else {
                // CLASICO / AKUMA
                if (miRol === "___IMPOSTOR___") {
                    icon.innerText="ü§´"; title.innerText="IMPOSTOR"; title.className="role-title impostor";
                    desc.innerHTML="No tienes personaje.<br>Escucha, deduce y miente.";
                } else {
                    icon.innerText="‚öì"; title.innerText="NAKAMA"; title.className="role-title crew";
                    desc.innerHTML=`Tu personaje secreto es:<br><span style="color:var(--gold); font-size:1.5rem; display:block; margin-top:5px;">${personajePartida}</span>`;
                    imgContainer.innerHTML = `<button class="btn-photo" onclick="abrirFotoModal('${personajePartida}')">üì∑ VER FOTO</button>`;
                }
            }
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function irAVotacion() {
            if(!confirm("¬øIr a votaci√≥n?")) return;
            document.getElementById('gameScreen').style.display = 'none'; document.getElementById('votingScreen').style.display = 'flex';
            const grid = document.getElementById('votingGrid'); grid.innerHTML = "";
            jugadores.forEach(n => {
                const btn = document.createElement('div'); btn.className = 'vote-card'; btn.innerText = n;
                btn.onclick = () => enviarVoto(n, btn); grid.appendChild(btn);
            });
            document.getElementById('secretCharacterDisplay').style.display = 'none'; document.getElementById('btnShowChar').style.display = 'none'; document.getElementById('btnImgSecret').style.display = 'none';
        }

        async function enviarVoto(target, btnElement) {
            if (heVotado) return;
            const buttons = document.querySelectorAll('.vote-card'); buttons.forEach(b => b.style.opacity = '0.5'); btnElement.style.opacity = '1'; btnElement.style.borderColor = 'var(--gold)';
            try { await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'vote', room: seedActual, player: miNombre, target: target }) }); heVotado = true; document.getElementById('votingStatus').innerText = "VOTO ENVIADO..."; } catch(e) { showToast("Error al votar"); }
        }

        function mostrarResultadoVotacion(expulsado) {
            if(document.getElementById('modalOverlay').style.display === 'flex' && document.getElementById('modalTitle').className.includes('win')) return;
            
            const seedParts = gameSeed.split('|');
            const gameMode = seedParts[2] || 'CLASSIC';
            const sorted = [...jugadores].sort();
            
            // ¬øQui√©n era el "malo"?
            // En CLASICO/AKUMA: El malo es ___IMPOSTOR___
            // En REVERSE: El "malo" (objetivo) es el que SABE la palabra
            const roleExpulsado = rolesPartida[sorted.indexOf(expulsado)];
            const soyImpostor = (miRol === "___IMPOSTOR___");
            
            let haGanadoTripulacion = false; // "Tripulaci√≥n" son los buenos (mayor√≠a)

            if (gameMode === 'REVERSE') {
                // Ganan los despistados (mayor√≠a) si echan al Sabio (palabra)
                if (roleExpulsado !== "___IMPOSTOR___") haGanadoTripulacion = true;
            } else {
                // Ganan los Nakamas (mayor√≠a) si echan al Impostor
                if (roleExpulsado === "___IMPOSTOR___") haGanadoTripulacion = true;
            }

            const icon=document.getElementById('modalIcon'), title=document.getElementById('modalTitle'), desc=document.getElementById('modalDesc');
            document.getElementById('modalImageContainer').innerHTML = '';
            
            let htmlDesc = "";
            
            // L√ìGICA DE MENSAJE FINAL
            if (haGanadoTripulacion) {
                // GANARON LOS BUENOS (MAYOR√çA)
                icon.innerText="üéâ"; title.innerText="¬°VICTORIA!"; title.className="role-title win";
                htmlDesc = `<span style="color:var(--red); font-weight:bold;">${expulsado}</span> ha sido eliminado correctamente.`;
            } else {
                // GANARON LOS MALOS (MINOR√çA/IMPOSTOR)
                icon.innerText="üíÄ"; title.innerText="DERROTA"; title.className="role-title impostor";
                htmlDesc = `Hab√©is expulsado a un inocente: <span style="color:white; font-weight:bold;">${expulsado}</span>.`;
            }

            desc.innerHTML = htmlDesc;
            let botonesHTML = `<button class="btn-photo" style="margin-bottom:10px; width:100%; justify-content:center;" onclick="abrirFotoModal('${personajePartida}')">üì∑ VER PERSONAJE SECRETO</button>`;
            if(soyLider) botonesHTML += '<button class="btn-main" onclick="reiniciarPartida()">üîÑ JUGAR OTRA VEZ</button>'; else botonesHTML += '<p style="font-size:0.8rem; color:#aaa;">Esperando al capit√°n para reiniciar...</p>';
            document.getElementById('modalButtons').innerHTML = botonesHTML; document.getElementById('modalOverlay').style.display = 'flex';
        }

        function mostrarPersonajeSecreto() { document.getElementById('secretCharacterDisplay').style.display = 'block'; document.getElementById('secretCharacterDisplay').innerText = personajePartida; document.getElementById('btnShowChar').style.display = 'none'; if (miRol !== "___IMPOSTOR___") document.getElementById('btnImgSecret').style.display = 'inline-flex'; }
        
        function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179)}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0,(h2^h3)>>>0,(h3^h4)>>>0,(h4^h1)>>>0]}
        function sfc32(a,b,c,d){return function(){a>>>=0;b>>>=0;c>>>=0;d>>>=0;var t=(a+b)|0;a=b^b>>>9;b=c+(c<<3)|0;c=(c<<21|c>>>11);d=d+1|0;t=t+d|0;c=c+t|0;return(t>>>0)/4294967296}}
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(()=>x.className=x.className.replace("show",""), 3000); }
        function copiarLink() { navigator.clipboard.writeText(window.location.href); showToast("Enlace copiado"); }
        function cerrarFotoModal() { document.getElementById('imgModal').style.display = 'none'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; if(document.getElementById('gameScreen').style.display !== 'none') { document.getElementById('myCard').classList.add('disabled'); document.querySelector('.card-icon').innerText = "‚úÖ"; document.querySelector('.card-name').innerText = "ROL VISTO"; document.querySelector('.card-hint').innerText = "ESPERANDO VOTACI√ìN..."; } }
        function resetCardVisual() { const c = document.getElementById('myCard'); c.classList.remove('disabled'); document.querySelector('.card-icon').innerText = "üëÜ"; document.querySelector('.card-name').innerText = miNombre; document.querySelector('.card-hint').innerText = "TOCA PARA VER TU ROL"; }
        
        async function abrirFotoModal(nombre) {
            const modal = document.getElementById('imgModal'); const img = document.getElementById('charImage'); const loader = document.getElementById('imgLoader'); const wantedName = document.getElementById('wantedName');
            modal.style.display = 'flex'; img.style.display = 'none'; loader.style.display = 'block';
            let displayName = nombre.split('(')[0].trim(); wantedName.innerText = displayName;
            const searchName = displayName; 
            const query = `query ($search: String) { Page(perPage: 5) { characters(search: $search) { name { full } image { large } media(sort: POPULARITY_DESC) { nodes { title { romaji english } } } } } }`;
            try {
                const res = await fetch('https://graphql.anilist.co', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query, variables: { search: searchName } }) });
                const json = await res.json();
                const chars = json.data.Page.characters;
                let best = chars.find(c => c.media.nodes.some(m => (m.title.romaji||"").includes("One Piece") || (m.title.english||"").includes("One Piece")))?.image.large;
                if (!best && chars.length > 0) best = chars[0].image.large;
                if(best) { img.src = best; img.onload = ()=>{ loader.style.display='none'; img.style.display='block'; }; } else { throw new Error(); }
            } catch { loader.style.display='none'; showToast("Buscando en Google..."); window.open(`https://www.google.com/search?tbm=isch&q=One+Piece+${displayName}`, '_blank'); modal.style.display='none'; }
        }
    </script>
</body>
</html>
